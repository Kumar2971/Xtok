const fs = require('fs')
const path = require('path')
const webpack = require('webpack')

const appDirectory = fs.realpathSync(process.cwd())
const resolveApp = relativePath => path.resolve(appDirectory, relativePath)

//MARK::Add Web Blocks
const appIncludes = [
resolveApp('../blocks/promocodes/src/'),
resolveApp('../blocks/core/src/'),
resolveApp('../blocks/videos/src/'),
resolveApp('../blocks/search/src/'),
resolveApp('../blocks/share/src/'),
resolveApp('../blocks/social-media-account-registration/src/'),
resolveApp('../blocks/social-media-account/src/'),
resolveApp('../blocks/email-account-login/src/'),
resolveApp('../blocks/utilities/src/'),
resolveApp('../blocks/email-account-registration/src/'),
resolveApp('../blocks/country-code-selector/src/'),
resolveApp('../blocks/forgot-password/src/'),
resolveApp('../blocks/otp-input-confirmation/src/'),
resolveApp('../blocks/social-media-account-login/src/'),
resolveApp('../blocks/pushnotifications/src/'),
resolveApp('../blocks/userstatus/src/'),
resolveApp('../blocks/dashboard/src/'),
resolveApp('../blocks/notificationsettings/src/'),
resolveApp('../blocks/invitefriends/src/'),
resolveApp('../blocks/user-profile-basic/src/'),
resolveApp('../blocks/educational-user-profile/src/'),
resolveApp('../blocks/splashscreen/src/'),
resolveApp('../blocks/analytics/src/'),
resolveApp('../blocks/filteritems/src/'),
resolveApp('../blocks/catalogue/src/'),
resolveApp('../blocks/mobile-account-registration/src/'),
resolveApp('../blocks/mobile-account-login/src/'),
resolveApp('../blocks/helpcentre/src/'),
resolveApp('../blocks/comments/src/'),
resolveApp('../blocks/postcreation/src/'),
resolveApp('../blocks/categoriessubcategories/src/'),
resolveApp('../blocks/location/src/'),
resolveApp('../blocks/blockedusers/src/'),
resolveApp('../blocks/maps/src/'),
resolveApp('../blocks/notifications/src/'),
resolveApp('../blocks/customisableusersubscriptions/src/'),
resolveApp('../blocks/favourites/src/'),
resolveApp('../blocks/contactus/src/'),
resolveApp('../blocks/qrcodes/src/'),
resolveApp('../blocks/VideoEditingTools/src/'),
resolveApp('../blocks/VideoLibrary/src/'),
resolveApp('../blocks/VideoManagement/src/'),
resolveApp('../blocks/Hashtags/src/'),
resolveApp('../blocks/AdManager/src/'),
resolveApp('../blocks/AudioEqualiser/src/'),
resolveApp('../blocks/AudioLibrary/src/'),
resolveApp('../blocks/Mentionstagging/src/'),
resolveApp('../blocks/InstantGiftCards/src/'),
resolveApp('../blocks/Followers/src/'),
resolveApp('../blocks/PrivacySettings/src/'),
resolveApp('../blocks/AdminConsole2/src/'),
resolveApp('../blocks/UploadMedia2/src/'),
resolveApp('../blocks/DataSaver/src/'),
resolveApp('../blocks/AudioEditor/src/'),
resolveApp('../blocks/VoiceMemos/src/'),
resolveApp('../blocks/EmailNotifications/src/'),
resolveApp('../blocks/Trending/src/'),
resolveApp('../blocks/Chat9/src/'),
resolveApp('../blocks/LiveStreaming/src/'),
resolveApp('../blocks/Settings5/src/'),
resolveApp('../blocks/LikeAPost/src/'),
resolveApp('../blocks/Payments/src/'),
resolveApp('../blocks/LanguageSupport/src/'),
resolveApp('../blocks/ApplePayIntegration/src/'),
resolveApp('../blocks/RolesPermissions2/src/'),
resolveApp('../blocks/TermsAndConditions/src/'),
resolveApp('../blocks/PaymentAdmin2/src/'),
resolveApp('../blocks/CfFaceEffectsIntegration/src/'),
resolveApp('../blocks/CfLiveChallenges/src/'),
resolveApp('../blocks/CfAppCoinsManagement/src/'),
resolveApp('../blocks/CfGiftDesign/src/'),
resolveApp('../blocks/AnimationsAndTransition3/src/'),
resolveApp('../blocks/CustomisableUserProfiles/src/'),
resolveApp('../blocks/LiveFeedScheduling/src/'),
resolveApp('../blocks/AmazonInteractiveVideoService/src/'),

  resolveApp('src'),
  resolveApp('../components/src'),
  resolveApp('../framework/src'),
  resolveApp('../../node_modules/react-native-permissions'),
  resolveApp('../../node_modules/react-native-web'),
  resolveApp('../../node_modules/radar_sdk_js'),
  resolveApp('../../node_modules/amazon-ivs-web-broadcast'),
  resolveApp('../../node_modules/react-native-watermark'),
  resolveApp('../../node_modules/react-native-video-controls'),
  resolveApp('../../node_modules/react-native-walkthrough-tooltip'),
  resolveApp('../../node_modules/react-native-view-shot'),
  resolveApp('../../node_modules/react-native-volume-slider'),
  resolveApp('../../node_modules/react-native-webview'),
  resolveApp('../../node_modules/react-native-elements'),
  resolveApp('../../node_modules/react-native-vector-icons'),
  resolveApp('../../node_modules/react-native-ratings'),
  resolveApp('../../node_modules/react-native-image-picker'),
  resolveApp('../../node_modules/react-native-check-box'),
  resolveApp('../../node_modules/react-native-toasty'),
  resolveApp('../../node_modules/react-native-tab-view'),
  resolveApp('../../node_modules/react-native-system-setting'),
  resolveApp('../../node_modules/react-native-svg'),
  resolveApp('../../node_modules/react-native-sound-recorder'),
  resolveApp('../../node_modules/react-native-sound'),
  resolveApp('../../node_modules/react-native-slider'),
  resolveApp('../../node_modules/react-native-simple-radio-button'),
  resolveApp('../../node_modules/react-native-share'),
  resolveApp('../../node_modules/react-native-push-notification'),
  resolveApp('../../node_modules/react-native-parsed-text'),
  resolveApp('../../node_modules/react-native-modal-datetime-picker'),
  resolveApp('../../node_modules/react-native-modal-activityindicator'),
  resolveApp('../../node_modules/react-native-material-textfield'),
  resolveApp('../../node_modules/react-native-material-dropdown'),
  resolveApp('../../node_modules/react-native-localize'),
  resolveApp('../../node_modules/react-native-live-audio-stream'),
  resolveApp('../../node_modules/react-native-image-to-pdf'),
  resolveApp('../../node_modules/react-native-image-marker'),
  resolveApp('../../node_modules/react-native-image-helper'),
  resolveApp('../../node_modules/react-native-image-crop-picker'),
  resolveApp('../../node_modules/react-native-camera'),
  resolveApp('../../node_modules/react-native-drag-resize'),
  resolveApp('../../node_modules/react-native-ffmpeg'),
  resolveApp('../../node_modules/react-native-screens'),
  resolveApp('../../node_modules/react-native-safe-area-context'),
  resolveApp('../../node_modules/"react-native-restart'),
  resolveApp('../../node_modules/react-native-responsive-dimensions'),
  resolveApp('../../node_modules/react-native-reanimated'),
  resolveApp('../../node_modules/react-native-raw-bottom-sheet'),
  resolveApp('../../node_modules/react-native-fs'),
  resolveApp('../../node_modules/rn-fetch-blob'),
  resolveApp('../../node_modules/react-native-calendars'),
  resolveApp('../../node_modules/react-native-swipe-gestures'),
  resolveApp('../../node_modules/@react-native-community/datetimepicker'),
  resolveApp('../../node_modules/react-native-animatable'),
  resolveApp('../../node_modules/react-native-confirmation-code-field'),
  resolveApp('../../node_modules/react-native-password-strength-meter'),
  resolveApp('../../node_modules/react-native-video-player'),
  resolveApp('../../node_modules/react-native-video'),
  resolveApp('../../node_modules/react-native-sqlite-storage'),
  resolveApp('../../node_modules/@react-native-firebase/app'),
  resolveApp('../../node_modules/@react-native-camera-roll/camera-roll'),
  resolveApp('../../node_modules/@react-native-firebase/messaging'),
  resolveApp('../../node_modules/@react-navigation/native'),
  resolveApp('../../node_modules/@invertase/react-native-apple-authentication'),
  resolveApp('../../node_modules/@ptomasroos/react-native-multi-slider'),
  resolveApp('../../node_modules/@react-native-camera-roll/camera-roll'),
  resolveApp('../../node_modules/@react-native-community/art'),
  resolveApp('../../node_modules/@react-native-community/checkbox'),
  resolveApp('../../node_modules/@react-native-community/clipboard'),
  resolveApp('../../node_modules/@react-native-community/datetimepicker'),
  resolveApp('../../node_modules/@react-native-community/masked-view'),
  resolveApp('../../node_modules/@react-native-community/netinfo'),
  resolveApp('../../node_modules/@react-native-community/push-notification-ios'),
  resolveApp('../../node_modules/@react-native-community/viewpager'),
  resolveApp('../../node_modules/@react-native-firebase/dynamic-links'),
  resolveApp('../../node_modules/@react-native-voice/voice'),
  resolveApp('../../node_modules/@react-navigation/bottom-tabs'),
  resolveApp('../../node_modules/@react-navigation/stack'),
  resolveApp('../../node_modules/@tradle/react-native-http'),
  resolveApp('../../node_modules/@twotalltotems/react-native-otp-input'),
  resolveApp('../../node_modules/@videosdk.live/react-native-incallmanager'),
  resolveApp('../../node_modules/@videosdk.live/react-native-sdk'),
  resolveApp('../../node_modules/@videosdk.live/react-sdk'),
  resolveApp('../../node_modules/react-native-calendar-picker'),
  resolveApp('../../node_modules/react-native-calendars'),
  resolveApp('../../node_modules/react-native-camera'),
  resolveApp('../../node_modules/react-native-chart-kit'),
  resolveApp('../../node_modules/react-native-confirmation-code-field'),
  resolveApp('../../node_modules/react-native-copy-asset'),
  resolveApp('../../node_modules/react-native-datepicker'),
  resolveApp('../../node_modules/react-native-document-picker'),
  resolveApp('../../node_modules/react-native-drag-resize'),
  resolveApp('../../node_modules/react-native-draggable-dynamic-flatlist'),
  resolveApp('../../node_modules/react-native-element-dropdown'),
  resolveApp('../../node_modules/react-native-emoji-board'),
  resolveApp('../../node_modules/react-native-emoji-selector'),
  resolveApp('../../node_modules/react-native-fast-image'),
  resolveApp('../../node_modules/react-native-geolocation-service'),
  resolveApp('../../node_modules/react-native-restart'),
  resolveApp('../../node_modules/react-native-size-matters'),
  resolveApp('../../node_modules/react-native-gesture-handler'),
  resolveApp('../../node_modules/react-native-image-crop-picker'),
  resolveApp('../../node_modules/react-native-keyboard-avoiding-scroll-view'),
  resolveApp('../../node_modules/react-native-keyboard-aware-scroll-view'),
  resolveApp('../../node_modules/react-native-keyboard-manager'),
  resolveApp('../../node_modules/react-native-iphone-x-helper'),
  resolveApp('../../node_modules/react-native-mask-input'),
  resolveApp('../../node_modules/react-native-material-tabs'),
  resolveApp('../../node_modules/react-native-material-textfield'),
  resolveApp('../../node_modules/react-native-modal'),
  resolveApp('../../node_modules/react-native-pager-view'),
  resolveApp('../../node_modules/react-native-raw-bottom-sheet'),
  resolveApp('../../node_modules/react-native-get-random-values'),
  resolveApp('../../node_modules/react-native-phone-number-input'),
  resolveApp('../../node_modules/react-native-progress'),
  resolveApp('../../node_modules/react-native-read-more-text'),
  resolveApp('../../node_modules/react-native-render-html'),
  resolveApp('../../node_modules/react-native-responsive-fontsize'),
  resolveApp('../../node_modules/react-native-responsive-screen'),
  resolveApp('../../node_modules/react-native-s3-upload'),
  resolveApp('../../node_modules/react-native-scl-alert'),
  resolveApp('../../node_modules/react-native-segmented-control-tab'),
  resolveApp('../../node_modules/react-native-share'),
  resolveApp('../../node_modules/react-native-slider'),
  resolveApp('../../node_modules/react-native-snap-carousel'),
  resolveApp('../../node_modules/react-native-sound'),
  resolveApp('../../node_modules/react-native-sound-player'),
  resolveApp('../../node_modules/react-native-sound-recorder'),
  resolveApp('../../node_modules/react-native-svg'),
  resolveApp('../../node_modules/react-native-swipe-list-view'),
  resolveApp('../../node_modules/react-native-swipeout'),
  resolveApp('../../node_modules/react-native-toast-message'),
  resolveApp('../../node_modules/react-native-toasty'),
  resolveApp('../../node_modules/react-native-trimmer'),
  resolveApp('../../node_modules/react-native-use-websocket'),
  resolveApp('../../node_modules/react-native-uuid'),
  resolveApp('../../node_modules/react-native-vector-icons'),
  resolveApp('../../node_modules/react-native-video'),
  resolveApp('../../node_modules/react-native-video-controls'),
  resolveApp('../../node_modules/react-native-volume-slider'),
  resolveApp('../../node_modules/react-native-walkthrough-tooltip'),
  resolveApp('../../node_modules/react-native-webview'),
  resolveApp('../../node_modules/rn-emoji-keyboard'),
  resolveApp('../../node_modules/rn-fetch-blob'),
  resolveApp('../blocks/restClient/src'),
  resolveApp('../blocks/alert/src'),
  resolveApp('../blocks/adapters/src'),
  resolveApp('../blocks/info-page/src')
]

const CompressionPlugin = require('compression-webpack-plugin'); //gzip
const BrotliPlugin = require('brotli-webpack-plugin'); //brotli

module.exports = function override(config, env) {
  // allow importing from outside of src folder
  config.resolve.plugins = config.resolve.plugins.filter(
    plugin => plugin.constructor.name !== 'ModuleScopePlugin'
  )
  config.module.rules[0].include = appIncludes
  config.module.rules[1] = null
  config.module.rules[2].oneOf[1].include = appIncludes
  config.module.rules[2].oneOf[1].options.plugins = [
    require.resolve('babel-plugin-react-native-web'),
  ].concat(config.module.rules[2].oneOf[1].options.plugins)
  config.module.rules = config.module.rules.filter(Boolean)
  config.plugins.push(
    new webpack.DefinePlugin({ __DEV__: env !== 'production' }),
    //gzip
    new CompressionPlugin({
      filename: '[path].gz[query]',
      algorithm: 'gzip',
      test: /\.(js|css|html|svg)$/,
      threshold: 8192,
      minRatio: 0.8
    }),
    //brotli plugin
    new BrotliPlugin({ 
      asset: '[path].br[query]',
      test: /\.(js|css|html|svg)$/,
      threshold: 10240,
      minRatio: 0.8
    }),
  )
  config.resolve.alias = {'react-native-maps': 'react-native-web-maps', 'react-native': 'react-native-web'};
  return config
}